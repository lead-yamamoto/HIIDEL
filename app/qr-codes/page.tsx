"use client";

import { useState, useEffect } from "react";
import { motion } from "framer-motion";
import { Download, Plus, QrCode, Share2, Loader2, Trash2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Sidebar } from "@/components/sidebar";
import { MobileHeader } from "@/components/mobile-header";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from "@/components/ui/dialog";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Card, CardContent } from "@/components/ui/card";
import { cn } from "@/lib/utils";
import { QRCodeDisplay } from "@/components/qr-code-display";
import { LoadingState, InlineLoading } from "@/components/ui/loading";

interface QRCode {
  id: string;
  storeId: string;
  name: string;
  type: "review" | "survey" | "contact";
  url: string;
  scans: number;
  createdAt: string;
}

interface Store {
  id: string;
  displayName: string;
  isTestStore: boolean;
}

interface Survey {
  id: string;
  title: string;
  shareUrl: string;
  isActive: boolean;
}

export default function QRCodesPage() {
  const [mounted, setMounted] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
  const [qrCodes, setQRCodes] = useState<QRCode[]>([]);
  const [stores, setStores] = useState<Store[]>([]);
  const [surveys, setSurveys] = useState<Survey[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedStore, setSelectedStore] = useState("");
  const [selectedSurvey, setSelectedSurvey] = useState("");
  const [selectedType, setSelectedType] = useState("");
  const [qrName, setQRName] = useState("");
  const [isCreating, setIsCreating] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [error, setError] = useState("");
  const [generatedUrl, setGeneratedUrl] = useState("");
  const [showQRCode, setShowQRCode] = useState(false);
  const [selectedQRCode, setSelectedQRCode] = useState<QRCode | null>(null);
  const [isQRPreviewOpen, setIsQRPreviewOpen] = useState(false);
  const [deletingQRCodeId, setDeletingQRCodeId] = useState<string | null>(null);
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
  const [qrCodeToDelete, setQRCodeToDelete] = useState<QRCode | null>(null);

  // Prevent hydration mismatch
  useEffect(() => {
    setMounted(true);
  }, []);

  useEffect(() => {
    if (mounted) {
      fetchData();
    }
  }, [mounted]);

  const fetchData = async () => {
    try {
      setIsLoading(true);
      console.log("üìã Fetching QR codes, stores, and surveys...");

      const [qrResponse, storesResponse, surveysResponse] = await Promise.all([
        fetch("/api/qr-codes"),
        fetch("/api/stores"),
        fetch("/api/surveys"),
      ]);

      if (qrResponse.ok) {
        const qrData = await qrResponse.json();
        setQRCodes(qrData.qrCodes || []);
      }

      if (storesResponse.ok) {
        const storesData = await storesResponse.json();
        console.log("üìä Stores data:", storesData);
        // storesData„ÅåÈÖçÂàó„ÅÆÂ†¥Âêà„Å®„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„Å´ÂØæÂøú
        const storesArray = Array.isArray(storesData)
          ? storesData
          : storesData.stores || [];
        setStores(storesArray);
      }

      if (surveysResponse.ok) {
        const surveysData = await surveysResponse.json();
        console.log("üìã Surveys data:", surveysData);
        // surveysData„ÅåÈÖçÂàó„ÅÆÂ†¥Âêà„Å®„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„Å´ÂØæÂøú
        const surveysArray = Array.isArray(surveysData)
          ? surveysData
          : surveysData.surveys || [];
        setSurveys(surveysArray);
      }

      console.log("‚úÖ Data fetched successfully");
    } catch (error) {
      console.error("‚ùå Error fetching data:", error);
    } finally {
      setIsLoading(false);
    }
  };

  const createQRCode = async () => {
    if (!selectedType || !qrName) {
      return;
    }

    // „Çø„Ç§„Éó„Å´Âøú„Åò„Å¶ÂøÖË¶Å„Å™ÈÅ∏ÊäûÈ†ÖÁõÆ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
    if (selectedType === "survey" && !selectedSurvey) {
      return;
    }
    if (
      (selectedType === "review" || selectedType === "contact") &&
      !selectedStore
    ) {
      return;
    }

    try {
      setIsCreating(true);
      console.log("üìù Creating QR code...");

      let url = "";
      let storeId = "";

      if (selectedType === "survey") {
        const survey = surveys.find((s) => s.id === selectedSurvey);
        if (survey) {
          url = survey.shareUrl;
          storeId = "survey"; // „Ç¢„É≥„Ç±„Éº„ÉàÂ∞ÇÁî®„ÅÆ„Çπ„Éà„Ç¢ID
        }
      } else {
        url = `${window.location.origin}/${selectedType}/${selectedStore}`;
        storeId = selectedStore;
      }

      const response = await fetch("/api/qr-codes", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          storeId: storeId,
          name: qrName,
          type: selectedType,
          url: url,
          surveyId: selectedType === "survey" ? selectedSurvey : undefined,
        }),
      });

      if (response.ok) {
        console.log("‚úÖ QR code created successfully");
        setIsCreateDialogOpen(false);
        setSelectedStore("");
        setSelectedSurvey("");
        setSelectedType("");
        setQRName("");
        await fetchData(); // „Éá„Éº„Çø„ÇíÂÜçÂèñÂæó
      } else {
        const errorData = await response.json();
        console.error("‚ùå Failed to create QR code:", errorData);
        setError(
          `QR„Ç≥„Éº„Éâ„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${errorData.error || "Unknown error"}`
        );
      }
    } catch (error) {
      console.error("üí• Error creating QR code:", error);
      setError(
        `„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${
          error instanceof Error ? error.message : "Unknown error"
        }`
      );
    } finally {
      setIsCreating(false);
    }
  };

  const generateQRCode = () => {
    if (!selectedStore || !selectedType) {
      setError("Â∫óËàó„Å®„Çø„Ç§„Éó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
      return;
    }

    setIsGenerating(true);
    setError("");

    try {
      const url = `${window.location.origin}/${selectedType}/${selectedStore}`;
      setGeneratedUrl(url);
      setShowQRCode(true);
    } catch (error) {
      setError("QR„Ç≥„Éº„Éâ„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
    } finally {
      setIsGenerating(false);
    }
  };

  const filteredQRCodes = searchTerm
    ? qrCodes.filter(
        (qrCode) =>
          qrCode.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          qrCode.type.toLowerCase().includes(searchTerm.toLowerCase())
      )
    : qrCodes;

  const downloadQRCode = (id: string) => {
    const qrCode = qrCodes.find((qr) => qr.id === id);
    if (qrCode) {
      setSelectedQRCode(qrCode);
      setIsQRPreviewOpen(true);
    }
  };

  const shareQRCode = (id: string) => {
    const qrCode = qrCodes.find((qr) => qr.id === id);
    if (qrCode) {
      setSelectedQRCode(qrCode);
      setIsQRPreviewOpen(true);
    }
  };

  const previewQRCode = (qrCode: QRCode) => {
    setSelectedQRCode(qrCode);
    setIsQRPreviewOpen(true);
  };

  const confirmDeleteQRCode = (qrCode: QRCode) => {
    setQRCodeToDelete(qrCode);
    setIsDeleteDialogOpen(true);
  };

  const deleteQRCode = async () => {
    if (!qrCodeToDelete) return;

    try {
      setDeletingQRCodeId(qrCodeToDelete.id);
      console.log(`üóëÔ∏è Deleting QR code: ${qrCodeToDelete.name}`);

      const response = await fetch(`/api/qr-codes?id=${qrCodeToDelete.id}`, {
        method: "DELETE",
      });

      if (response.ok) {
        console.log("‚úÖ QR code deleted successfully");
        await fetchData(); // „Éá„Éº„Çø„ÇíÂÜçÂèñÂæó
        setIsDeleteDialogOpen(false);
        setQRCodeToDelete(null);
      } else {
        console.error("‚ùå Failed to delete QR code");
      }
    } catch (error) {
      console.error("üí• Error deleting QR code:", error);
    } finally {
      setDeletingQRCodeId(null);
    }
  };

  const getStoreName = (storeId: string) => {
    const store = stores.find((s) => s.id === storeId);
    return store ? store.displayName : "‰∏çÊòé„Å™Â∫óËàó";
  };

  const getTypeLabel = (type: string) => {
    switch (type) {
      case "review":
        return "Google„É¨„Éì„É•„Éº";
      case "survey":
        return "„Ç¢„É≥„Ç±„Éº„Éà";
      case "contact":
        return "„ÅäÂïè„ÅÑÂêà„Çè„Åõ";
      default:
        return type;
    }
  };

  if (!mounted) return null;

  if (isLoading) {
    return (
      <div className="flex min-h-screen bg-background text-foreground">
        <div className="hidden md:block w-64">
          <Sidebar currentPath="/qr-codes" />
        </div>
        <div className="flex-1 flex flex-col">
          <MobileHeader
            title="QR„Ç≥„Éº„ÉâÁÆ°ÁêÜ"
            currentPath="/qr-codes"
            searchPlaceholder="QR„Ç≥„Éº„Éâ„ÇíÊ§úÁ¥¢..."
            backUrl="/"
          />
          <div className="flex-1 flex items-center justify-center">
            <LoadingState message="QR„Ç≥„Éº„Éâ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠..." />
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="flex min-h-screen bg-background text-foreground">
      {/* Desktop sidebar */}
      <div className="hidden md:block w-64">
        <Sidebar currentPath="/qr-codes" />
      </div>

      {/* Main content */}
      <div className="flex-1 flex flex-col">
        {/* Header */}
        <MobileHeader
          title="QR„Ç≥„Éº„ÉâÁÆ°ÁêÜ"
          currentPath="/qr-codes"
          searchPlaceholder="QR„Ç≥„Éº„Éâ„ÇíÊ§úÁ¥¢..."
          searchValue={searchTerm}
          onSearchChange={setSearchTerm}
          backUrl="/"
        />

        {/* Main area */}
        <div className="flex-1 overflow-auto p-4 md:p-6">
          <div className="max-w-7xl mx-auto">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
              <motion.h1
                className="text-xl md:text-2xl font-bold"
                initial={{ opacity: 0, y: -20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.3 }}
              >
                QR„Ç≥„Éº„ÉâÁÆ°ÁêÜ
              </motion.h1>
              <Dialog
                open={isCreateDialogOpen}
                onOpenChange={setIsCreateDialogOpen}
              >
                <DialogTrigger asChild>
                  <Button
                    className="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white border-none"
                    disabled={stores.length === 0 && surveys.length === 0}
                  >
                    <Plus size={16} className="mr-2" /> QR„Ç≥„Éº„Éâ„Çí‰ΩúÊàê
                  </Button>
                </DialogTrigger>
                <DialogContent className="sm:max-w-[425px]">
                  <DialogHeader>
                    <DialogTitle>Êñ∞„Åó„ÅÑQR„Ç≥„Éº„Éâ„Çí‰ΩúÊàê</DialogTitle>
                    <DialogDescription>
                      Á®ÆÈ°û„ÇíÈÅ∏Êäû„Åó„Å¶„ÄÅÊñ∞„Åó„ÅÑQR„Ç≥„Éº„Éâ„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ
                    </DialogDescription>
                  </DialogHeader>
                  <div className="grid gap-4 py-4">
                    <div className="grid grid-cols-4 items-center gap-4">
                      <Label htmlFor="type" className="text-right">
                        Á®ÆÈ°û
                      </Label>
                      <Select
                        value={selectedType}
                        onValueChange={(value) => {
                          setSelectedType(value);
                          setSelectedStore("");
                          setSelectedSurvey("");
                        }}
                      >
                        <SelectTrigger className="col-span-3">
                          <SelectValue placeholder="Á®ÆÈ°û„ÇíÈÅ∏Êäû" />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="review">Google„É¨„Éì„É•„Éº</SelectItem>
                          <SelectItem value="survey">„Ç¢„É≥„Ç±„Éº„Éà</SelectItem>
                          <SelectItem value="contact">„ÅäÂïè„ÅÑÂêà„Çè„Åõ</SelectItem>
                        </SelectContent>
                      </Select>
                    </div>

                    {/* Â∫óËàóÈÅ∏ÊäûÔºàreview/contact„Çø„Ç§„Éó„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫Ôºâ */}
                    {(selectedType === "review" ||
                      selectedType === "contact") && (
                      <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="store" className="text-right">
                          Â∫óËàó
                        </Label>
                        <Select
                          value={selectedStore}
                          onValueChange={setSelectedStore}
                        >
                          <SelectTrigger className="col-span-3">
                            <SelectValue placeholder="Â∫óËàó„ÇíÈÅ∏Êäû" />
                          </SelectTrigger>
                          <SelectContent>
                            {stores.map((store) => (
                              <SelectItem key={store.id} value={store.id}>
                                {store.displayName}
                                {store.isTestStore && " („ÉÜ„Çπ„Éà)"}
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>
                    )}

                    {/* „Ç¢„É≥„Ç±„Éº„ÉàÈÅ∏ÊäûÔºàsurvey„Çø„Ç§„Éó„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫Ôºâ */}
                    {selectedType === "survey" && (
                      <div className="grid grid-cols-4 items-center gap-4">
                        <Label htmlFor="survey" className="text-right">
                          „Ç¢„É≥„Ç±„Éº„Éà
                        </Label>
                        <Select
                          value={selectedSurvey}
                          onValueChange={setSelectedSurvey}
                        >
                          <SelectTrigger className="col-span-3">
                            <SelectValue placeholder="„Ç¢„É≥„Ç±„Éº„Éà„ÇíÈÅ∏Êäû" />
                          </SelectTrigger>
                          <SelectContent>
                            {surveys
                              .filter((survey) => survey.isActive)
                              .map((survey) => (
                                <SelectItem key={survey.id} value={survey.id}>
                                  {survey.title}
                                </SelectItem>
                              ))}
                          </SelectContent>
                        </Select>
                      </div>
                    )}

                    <div className="grid grid-cols-4 items-center gap-4">
                      <Label htmlFor="name" className="text-right">
                        ÂêçÂâç
                      </Label>
                      <Input
                        id="name"
                        placeholder="QR„Ç≥„Éº„Éâ„ÅÆÂêçÂâç"
                        className="col-span-3"
                        value={qrName}
                        onChange={(e) => setQRName(e.target.value)}
                      />
                    </div>
                  </div>
                  {error && (
                    <div className="bg-red-50 border border-red-200 rounded-md p-3 mb-4">
                      <div className="text-red-700 text-sm">{error}</div>
                    </div>
                  )}
                  <DialogFooter>
                    <Button
                      type="submit"
                      onClick={() => {
                        setError("");
                        createQRCode();
                      }}
                      disabled={
                        !selectedType ||
                        !qrName ||
                        isCreating ||
                        (selectedType === "survey" && !selectedSurvey) ||
                        ((selectedType === "review" ||
                          selectedType === "contact") &&
                          !selectedStore)
                      }
                    >
                      {isCreating ? <InlineLoading text="‰ΩúÊàê‰∏≠..." /> : "‰ΩúÊàê"}
                    </Button>
                  </DialogFooter>
                </DialogContent>
              </Dialog>
            </div>

            {qrCodes.length === 0 ? (
              <Card className="p-8 text-center">
                <CardContent>
                  <QrCode className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <h3 className="text-lg font-medium mb-2">
                    QR„Ç≥„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                  </h3>
                  <p className="text-gray-600 mb-4">
                    {stores.length === 0 && surveys.length === 0
                      ? "„Åæ„ÅöÂ∫óËàó„ÇíËøΩÂä†„Åô„Çã„Åã„ÄÅ„Ç¢„É≥„Ç±„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åã„Çâ„ÄÅQR„Ç≥„Éº„Éâ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                      : "ÊúÄÂàù„ÅÆQR„Ç≥„Éº„Éâ„Çí‰ΩúÊàê„Åó„Å¶„ÄÅÈ°ßÂÆ¢„Å®„ÅÆ„Ç®„É≥„Ç≤„Éº„Ç∏„É°„É≥„Éà„ÇíÈñãÂßã„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ"}
                  </p>
                  {(stores.length > 0 || surveys.length > 0) && (
                    <Button
                      onClick={() => setIsCreateDialogOpen(true)}
                      className="bg-blue-600 hover:bg-blue-700 text-white"
                    >
                      <Plus className="mr-2 h-4 w-4" />
                      QR„Ç≥„Éº„Éâ„Çí‰ΩúÊàê
                    </Button>
                  )}
                </CardContent>
              </Card>
            ) : (
              <>
                <Tabs defaultValue="all" className="w-full mb-6">
                  <TabsList>
                    <TabsTrigger value="all">
                      „Åô„Åπ„Å¶ ({qrCodes.length})
                    </TabsTrigger>
                    <TabsTrigger value="review">
                      Google„É¨„Éì„É•„Éº (
                      {qrCodes.filter((q) => q.type === "review").length})
                    </TabsTrigger>
                    <TabsTrigger value="survey">
                      „Ç¢„É≥„Ç±„Éº„Éà (
                      {qrCodes.filter((q) => q.type === "survey").length})
                    </TabsTrigger>
                    <TabsTrigger value="contact">
                      „ÅäÂïè„ÅÑÂêà„Çè„Åõ (
                      {qrCodes.filter((q) => q.type === "contact").length})
                    </TabsTrigger>
                  </TabsList>

                  <TabsContent value="all">
                    <QRCodeGrid
                      qrCodes={filteredQRCodes}
                      onDownload={downloadQRCode}
                      onShare={shareQRCode}
                      onPreview={previewQRCode}
                      onDelete={confirmDeleteQRCode}
                      getStoreName={getStoreName}
                      getTypeLabel={getTypeLabel}
                      deletingQRCodeId={deletingQRCodeId}
                    />
                  </TabsContent>

                  <TabsContent value="review">
                    <QRCodeGrid
                      qrCodes={filteredQRCodes.filter(
                        (q) => q.type === "review"
                      )}
                      onDownload={downloadQRCode}
                      onShare={shareQRCode}
                      onPreview={previewQRCode}
                      onDelete={confirmDeleteQRCode}
                      getStoreName={getStoreName}
                      getTypeLabel={getTypeLabel}
                      deletingQRCodeId={deletingQRCodeId}
                    />
                  </TabsContent>

                  <TabsContent value="survey">
                    <QRCodeGrid
                      qrCodes={filteredQRCodes.filter(
                        (q) => q.type === "survey"
                      )}
                      onDownload={downloadQRCode}
                      onShare={shareQRCode}
                      onPreview={previewQRCode}
                      onDelete={confirmDeleteQRCode}
                      getStoreName={getStoreName}
                      getTypeLabel={getTypeLabel}
                      deletingQRCodeId={deletingQRCodeId}
                    />
                  </TabsContent>

                  <TabsContent value="contact">
                    <QRCodeGrid
                      qrCodes={filteredQRCodes.filter(
                        (q) => q.type === "contact"
                      )}
                      onDownload={downloadQRCode}
                      onShare={shareQRCode}
                      onPreview={previewQRCode}
                      onDelete={confirmDeleteQRCode}
                      getStoreName={getStoreName}
                      getTypeLabel={getTypeLabel}
                      deletingQRCodeId={deletingQRCodeId}
                    />
                  </TabsContent>
                </Tabs>
              </>
            )}
          </div>
        </div>

        {/* QR„Ç≥„Éº„Éâ„Éó„É¨„Éì„É•„Éº„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */}
        <Dialog open={isQRPreviewOpen} onOpenChange={setIsQRPreviewOpen}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle>QR„Ç≥„Éº„Éâ</DialogTitle>
              <DialogDescription>{selectedQRCode?.name}</DialogDescription>
            </DialogHeader>
            {selectedQRCode && (
              <QRCodeDisplay
                url={selectedQRCode.url}
                title={selectedQRCode.name}
                size={200}
              />
            )}
          </DialogContent>
        </Dialog>

        {/* QR„Ç≥„Éº„ÉâÂâäÈô§Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */}
        <AlertDialog
          open={isDeleteDialogOpen}
          onOpenChange={setIsDeleteDialogOpen}
        >
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>QR„Ç≥„Éº„Éâ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</AlertDialogTitle>
              <AlertDialogDescription>
                „Äå{qrCodeToDelete?.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÄÇ
                <br />
                „Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åô„Åì„Å®„Åå„Åß„Åç„Åæ„Åõ„Çì„ÄÇ
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>„Ç≠„É£„É≥„Çª„É´</AlertDialogCancel>
              <AlertDialogAction
                onClick={deleteQRCode}
                className="bg-red-600 hover:bg-red-700"
                disabled={!!deletingQRCodeId}
              >
                {deletingQRCodeId === qrCodeToDelete?.id ? (
                  <>
                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                    ÂâäÈô§‰∏≠...
                  </>
                ) : (
                  "ÂâäÈô§"
                )}
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </div>
    </div>
  );
}

interface QRCodeGridProps {
  qrCodes: QRCode[];
  onDownload: (id: string) => void;
  onShare: (id: string) => void;
  onPreview: (qrCode: QRCode) => void;
  onDelete: (qrCode: QRCode) => void;
  getStoreName: (storeId: string) => string;
  getTypeLabel: (type: string) => string;
  deletingQRCodeId: string | null;
}

function QRCodeGrid({
  qrCodes,
  onDownload,
  onShare,
  onPreview,
  onDelete,
  getStoreName,
  getTypeLabel,
  deletingQRCodeId,
}: QRCodeGridProps) {
  if (qrCodes.length === 0) {
    return (
      <Card className="p-8 text-center">
        <CardContent>
          <QrCode className="h-12 w-12 mx-auto mb-4 text-gray-400" />
          <h3 className="text-lg font-medium mb-2">
            Ë©≤ÂΩì„Åô„ÇãQR„Ç≥„Éº„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
          </h3>
          <p className="text-gray-600">
            „Éï„Ç£„É´„Çø„Éº„ÇíÂ§âÊõ¥„Åô„Çã„Åã„ÄÅÊñ∞„Åó„ÅÑQR„Ç≥„Éº„Éâ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {qrCodes.map((qrCode, index) => (
        <motion.div
          key={qrCode.id}
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.3, delay: index * 0.1 }}
        >
          <Card className="hover:shadow-lg transition-shadow">
            <CardContent className="p-6">
              <div className="flex items-start justify-between mb-4">
                <div className="flex-1">
                  <h3 className="font-medium text-lg mb-1 line-clamp-2">
                    {qrCode.name}
                  </h3>
                  <p className="text-sm text-gray-600 mb-1">
                    {getStoreName(qrCode.storeId)}
                  </p>
                  <span className="inline-block px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">
                    {getTypeLabel(qrCode.type)}
                  </span>
                </div>
                <div className="flex-shrink-0 ml-4">
                  <div
                    className="w-16 h-16 bg-gray-100 border-2 border-gray-300 rounded flex items-center justify-center cursor-pointer hover:bg-gray-200 transition-colors"
                    onClick={() => onPreview(qrCode)}
                  >
                    <QrCode className="h-8 w-8 text-gray-500" />
                  </div>
                </div>
              </div>

              <div className="flex items-center justify-between text-sm text-gray-600 mb-4">
                <span>„Çπ„Ç≠„É£„É≥Êï∞: {qrCode.scans}</span>
                <span>
                  ‰ΩúÊàêÊó•:{" "}
                  {new Date(qrCode.createdAt).toLocaleDateString("ja-JP")}
                </span>
              </div>

              <div className="flex gap-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => onPreview(qrCode)}
                  className="flex-1"
                >
                  <QrCode size={14} className="mr-1" />
                  Ë°®Á§∫
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => onDownload(qrCode.id)}
                  className="flex-1"
                >
                  <Download size={14} className="mr-1" />
                  DL
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => onShare(qrCode.id)}
                  className="flex-1"
                >
                  <Share2 size={14} className="mr-1" />
                  ÂÖ±Êúâ
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => onDelete(qrCode)}
                  disabled={deletingQRCodeId === qrCode.id}
                  className="text-red-600 hover:text-red-700 hover:bg-red-50"
                >
                  {deletingQRCodeId === qrCode.id ? (
                    <Loader2 size={14} className="animate-spin" />
                  ) : (
                    <Trash2 size={14} />
                  )}
                </Button>
              </div>
            </CardContent>
          </Card>
        </motion.div>
      ))}
    </div>
  );
}
