import { NextRequest, NextResponse } from "next/server";
import { getServerSession } from "next-auth/next";
import { db } from "@/lib/database";
import { cookies } from "next/headers";

async function getAuthenticatedUserId(): Promise<string | null> {
  try {
    const session = await getServerSession();
    if (session?.user?.id) {
      return session.user.id;
    }
    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éá„É¢„É¶„Éº„Ç∂„Éº
    return "1";
  } catch (error) {
    console.error("Ë™çË®º„Ç®„É©„Éº:", error);
    return "1"; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
  }
}

export async function GET(request: NextRequest) {
  try {
    // „Éõ„Éº„É†„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁî®ÔºöË™çË®º„Å™„Åó„Åß„ÇÇÂü∫Êú¨„Éá„Éº„Çø„ÇíÊèê‰æõ
    const userId = await getAuthenticatedUserId();
    if (!userId) {
      console.log(
        "üîê No authenticated user, returning basic analytics without auth"
      );

      // Ë™çË®º„Å™„Åó„Åß„ÇÇÂü∫Êú¨ÁöÑ„Å™Â∫óËàó„Éá„Éº„Çø„ÇíÂèñÂæó
      try {
        const basicStores = await db.getStores("1"); // „Éá„Éï„Ç©„É´„Éà„É¶„Éº„Ç∂„Éº„ÅÆ„Éá„Éº„Çø
        const basicAnalytics = {
          totalStores: basicStores.length,
          totalReviews: 0,
          averageRating: 0,
          unansweredReviews: 0,
          responseRate: 0,
          totalQRScans: 0,
          totalSurveyResponses: 0,
          todayReviews: 0,
          todayScans: 0,
          hasRealData: false,
          period: 30,
          storeId: null,
          dailyReviews: [],
          dailyScans: [],
          ratingDistribution: [0, 0, 0, 0, 0],
          storeStats: basicStores.map((store: any) => ({
            storeId: store.id,
            storeName: store.displayName,
            reviewCount: 0,
            averageRating: 0,
            unansweredReviews: 0,
          })),
          message:
            basicStores.length > 0
              ? `${basicStores.length}‰ª∂„ÅÆÂ∫óËàó„ÅåÁôªÈå≤Ê∏à„Åø„Åß„Åô„ÄÇGoogle Business Profile„Å®ÈÄ£Êê∫„Åô„Çã„Å®„É¨„Éì„É•„Éº„Éá„Éº„Çø„ÇíË°®Á§∫„Åß„Åç„Åæ„Åô„ÄÇ`
              : "Â∫óËàó„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöÂ∫óËàó„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        };
        return NextResponse.json(basicAnalytics);
      } catch (dbError) {
        console.error("‚ùå Failed to fetch basic store data:", dbError);
        return NextResponse.json({
          totalStores: 0,
          totalReviews: 0,
          averageRating: 0,
          unansweredReviews: 0,
          responseRate: 0,
          totalQRScans: 0,
          totalSurveyResponses: 0,
          todayReviews: 0,
          todayScans: 0,
          hasRealData: false,
          period: 30,
          storeId: null,
          message: "„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ",
        });
      }
    }

    const { searchParams } = new URL(request.url);
    const storeId = searchParams.get("storeId");
    const period = searchParams.get("period") || "30"; // „Éá„Éï„Ç©„É´„Éà30Êó•

    console.log(
      `üìä Fetching analytics data for ${
        storeId ? "store " + storeId : "all stores"
      } (${period} days)`
    );

    const cookieStore = await cookies();
    const accessToken = cookieStore.get("google_access_token")?.value;

    // Â∫óËàó„Éá„Éº„Çø„ÇíÂèñÂæó
    const allStores = await db.getStores(userId);
    const targetStores = storeId
      ? allStores.filter((s: any) => s.id === storeId)
      : allStores;

    console.log(`üè™ Found ${targetStores.length} stores for analytics`);

    // GoogleË™çË®º„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂü∫Êú¨ÁöÑ„Å™Áµ±Ë®à„Éá„Éº„Çø„ÅÆ„ÅøËøî„Åô
    if (!accessToken) {
      console.log("üîê No Google access token, returning basic analytics");

      const basicAnalytics = {
        totalStores: targetStores.length,
        totalReviews: 0,
        averageRating: 0,
        unansweredReviews: 0,
        responseRate: 0,
        totalQRScans: 0,
        totalSurveyResponses: 0,
        todayReviews: 0,
        todayScans: 0,
        hasRealData: false,
        period: parseInt(period),
        storeId: storeId || null,

        // „ÉÅ„É£„Éº„ÉàÁî®„ÅÆ„ÉÄ„Éü„Éº„Éá„Éº„Çø
        dailyReviews: [],
        dailyScans: [],
        ratingDistribution: [0, 0, 0, 0, 0],

        // Â∫óËàóÂà•Áµ±Ë®à
        storeStats: targetStores.map((store: any) => ({
          storeId: store.id,
          storeName: store.displayName,
          reviewCount: 0,
          averageRating: 0,
          unansweredReviews: 0,
        })),

        message:
          targetStores.length > 0
            ? `${targetStores.length}‰ª∂„ÅÆÂ∫óËàó„ÅåÁôªÈå≤Ê∏à„Åø„Åß„Åô„ÄÇGoogle Business Profile„Å®ÈÄ£Êê∫„Åô„Çã„Å®„É¨„Éì„É•„Éº„Éá„Éº„Çø„ÇíË°®Á§∫„Åß„Åç„Åæ„Åô„ÄÇ`
            : "Â∫óËàó„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Åæ„ÅöÂ∫óËàó„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
      };

      return NextResponse.json(basicAnalytics);
    }

    try {
      // Google Business Profile„Åã„Çâ„É¨„Éì„É•„Éº„ÇíÂèñÂæó
      const allReviews: any[] = [];

      for (const store of targetStores) {
        if (!store.googleLocationId) {
          console.log(
            `‚ö†Ô∏è Store ${store.displayName} has no Google Location ID, skipping`
          );
          continue;
        }

        try {
          console.log(
            `üìù Fetching reviews for analytics: ${store.displayName} (${store.googleLocationId})`
          );

          // „Åæ„Åö„Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
          console.log(`üîç Getting account information for analytics...`);
          const accountsResponse = await fetch(
            "https://mybusinessaccountmanagement.googleapis.com/v1/accounts",
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!accountsResponse.ok) {
            console.error(
              `‚ùå Failed to fetch accounts for analytics: ${accountsResponse.status}`
            );
            continue;
          }

          const accountsData = await accountsResponse.json();
          if (!accountsData.accounts || accountsData.accounts.length === 0) {
            console.error(`‚ùå No accounts found for analytics`);
            continue;
          }

          // ÊúÄÂàù„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„Çí‰ΩøÁî®ÔºàÈÄöÂ∏∏„ÅØ1„Å§„Åó„Åã„Å™„ÅÑÔºâ
          const accountName = accountsData.accounts[0].name;
          console.log(`‚úÖ Using account for analytics: ${accountName}`);

          // Ê≠£„Åó„ÅÑGoogle My Business API v4.9„ÅÆ„É¨„Éì„É•„Éº„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Çí‰ΩøÁî®
          const apiUrl = `https://mybusiness.googleapis.com/v4/${accountName}/locations/${store.googleLocationId}/reviews`;

          const reviewsResponse = await fetch(apiUrl, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "Content-Type": "application/json",
            },
          });

          if (reviewsResponse.ok) {
            const reviewsData = await reviewsResponse.json();

            if (reviewsData.reviews && reviewsData.reviews.length > 0) {
              const processedReviews = reviewsData.reviews.map(
                (review: any) => ({
                  id:
                    review.reviewId ||
                    review.name ||
                    `review_${Date.now()}_${Math.random()}`,
                  storeId: store.id,
                  storeName: store.displayName,
                  rating:
                    review.starRating === "FIVE"
                      ? 5
                      : review.starRating === "FOUR"
                      ? 4
                      : review.starRating === "THREE"
                      ? 3
                      : review.starRating === "TWO"
                      ? 2
                      : review.starRating === "ONE"
                      ? 1
                      : typeof review.starRating === "number"
                      ? review.starRating
                      : 0,
                  comment: review.comment || "",
                  reviewer: {
                    displayName: review.reviewer?.displayName || "ÂåøÂêç„É¶„Éº„Ç∂„Éº",
                  },
                  createdAt: review.createTime || new Date().toISOString(),
                  replied: !!review.reviewReply,
                  replyText: review.reviewReply?.comment || null,
                  isRealData: true,
                })
              );

              allReviews.push(...processedReviews);
              console.log(
                `‚úÖ Added ${processedReviews.length} real reviews for analytics from ${store.displayName}`
              );
            } else {
              console.log(
                `üìù No reviews found for analytics from ${store.displayName}`
              );
            }
          } else {
            console.warn(
              `‚ö†Ô∏è Failed to fetch reviews for analytics from ${store.displayName}:`,
              reviewsResponse.status
            );

            // „Éà„Éº„ÇØ„É≥„É™„Éï„É¨„ÉÉ„Ç∑„É•„ÇíË©¶Ë°å
            if (reviewsResponse.status === 401) {
              console.log(`üîÑ Trying to refresh access token for analytics...`);
              try {
                const refreshResponse = await fetch(
                  "/api/google/refresh-token",
                  {
                    method: "POST",
                  }
                );

                if (refreshResponse.ok) {
                  console.log(
                    `‚úÖ Token refreshed, retrying analytics fetch...`
                  );
                  // Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„É≥„ÅßÂÜçË©¶Ë°å
                  const newCookieStore = await cookies();
                  const newAccessToken = newCookieStore.get(
                    "google_access_token"
                  )?.value;

                  if (newAccessToken) {
                    const retryResponse = await fetch(apiUrl, {
                      headers: {
                        Authorization: `Bearer ${newAccessToken}`,
                        "Content-Type": "application/json",
                      },
                    });

                    if (retryResponse.ok) {
                      const retryData = await retryResponse.json();
                      if (retryData.reviews && retryData.reviews.length > 0) {
                        const processedReviews = retryData.reviews.map(
                          (review: any) => ({
                            id:
                              review.reviewId ||
                              review.name ||
                              `review_${Date.now()}_${Math.random()}`,
                            storeId: store.id,
                            storeName: store.displayName,
                            rating:
                              review.starRating === "FIVE"
                                ? 5
                                : review.starRating === "FOUR"
                                ? 4
                                : review.starRating === "THREE"
                                ? 3
                                : review.starRating === "TWO"
                                ? 2
                                : review.starRating === "ONE"
                                ? 1
                                : typeof review.starRating === "number"
                                ? review.starRating
                                : 0,
                            comment: review.comment || "",
                            reviewer: {
                              displayName:
                                review.reviewer?.displayName || "ÂåøÂêç„É¶„Éº„Ç∂„Éº",
                            },
                            createdAt:
                              review.createTime || new Date().toISOString(),
                            replied: !!review.reviewReply,
                            replyText: review.reviewReply?.comment || null,
                            isRealData: true,
                          })
                        );

                        allReviews.push(...processedReviews);
                        console.log(
                          `‚úÖ Added ${processedReviews.length} real reviews for analytics from ${store.displayName} after token refresh`
                        );
                      }
                    }
                  }
                }
              } catch (refreshError) {
                console.error(
                  "Token refresh failed for analytics:",
                  refreshError
                );
              }
            }
          }
        } catch (error) {
          console.warn(
            `‚ö†Ô∏è Error fetching reviews for analytics from ${store.displayName}:`,
            error
          );
        }
      }

      // ÊúüÈñì„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
      const periodDays = parseInt(period);
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - periodDays);

      const filteredReviews = allReviews.filter((review: any) => {
        const reviewDate = new Date(review.createdAt);
        return reviewDate >= cutoffDate;
      });

      // ‰ªäÊó•„ÅÆ„Éá„Éº„Çø
      const today = new Date().toISOString().split("T")[0];
      const todayReviews = allReviews.filter(
        (r: any) => r.createdAt && r.createdAt.startsWith(today)
      ).length;

      // ÂàÜÊûê„Éá„Éº„Çø„ÇíË®àÁÆó
      const totalReviews = filteredReviews.length;
      const averageRating =
        totalReviews > 0
          ? filteredReviews.reduce(
              (sum: number, r: any) => sum + (r.rating || 0),
              0
            ) / totalReviews
          : 0;

      const unansweredReviews = filteredReviews.filter(
        (r: any) => !r.replied
      ).length;
      const responseRate =
        totalReviews > 0
          ? Math.round(
              ((totalReviews - unansweredReviews) / totalReviews) * 100
            )
          : 0;

      // Ë©ï‰æ°ÂàÜÂ∏É„ÇíË®àÁÆó
      const ratingDistribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
      filteredReviews.forEach((review: any) => {
        const rating = Math.floor(review.rating || 0);
        if (rating >= 1 && rating <= 5) {
          ratingDistribution[rating as keyof typeof ratingDistribution]++;
        }
      });

      // Êó•Âà•„Éá„Éº„Çø„ÇíÁîüÊàê
      const generateDailyData = (type: "reviews" | "scans", days: number) => {
        const data = [];
        for (let i = days - 1; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split("T")[0];

          let value = 0;
          if (type === "reviews") {
            value = allReviews.filter(
              (r: any) => r.createdAt && r.createdAt.startsWith(dateStr)
            ).length;
          } else {
            // QR„Çπ„Ç≠„É£„É≥„Éá„Éº„Çø„ÅØÂÆüÈöõ„ÅÆÂ∫óËàó„Åß„ÅØ0
            value = 0;
          }

          data.push({
            date: dateStr,
            value,
            dayOfWeek: date.getDay(),
          });
        }
        return data;
      };

      const analyticsData = {
        totalStores: targetStores.length,
        totalReviews,
        averageRating: Math.round(averageRating * 10) / 10,
        unansweredReviews,
        responseRate,
        totalQRScans: 0, // ÂÆüÈöõ„ÅÆGoogle API„Å´„ÅØÂê´„Åæ„Çå„Å™„ÅÑ
        totalSurveyResponses: 0, // ÂÆüÈöõ„ÅÆGoogle API„Å´„ÅØÂê´„Åæ„Çå„Å™„ÅÑ
        todayReviews,
        todayScans: 0,
        hasRealData: true,
        period,
        storeId: storeId || null,

        // „ÉÅ„É£„Éº„ÉàÁî®„Éá„Éº„Çø
        dailyReviews: generateDailyData("reviews", periodDays),
        dailyScans: generateDailyData("scans", periodDays),
        ratingDistribution,

        // Â∫óËàóÂà•Áµ±Ë®à
        storeStats: targetStores.map((store: any) => {
          const storeReviews = allReviews.filter(
            (r: any) => r.storeId === store.id
          );
          const storeAvgRating =
            storeReviews.length > 0
              ? storeReviews.reduce(
                  (sum: number, r: any) => sum + (r.rating || 0),
                  0
                ) / storeReviews.length
              : 0;

          return {
            storeId: store.id,
            storeName: store.displayName,
            reviewCount: storeReviews.length,
            averageRating: Math.round(storeAvgRating * 10) / 10,
            unansweredReviews: storeReviews.filter((r: any) => !r.replied)
              .length,
          };
        }),
      };

      console.log(
        `‚úÖ Calculated analytics from Google Business Profile data:`,
        {
          stores: targetStores.length,
          reviews: totalReviews,
          avgRating: analyticsData.averageRating,
        }
      );

      return NextResponse.json(analyticsData);
    } catch (dataError) {
      console.error("Error fetching analytics data:", dataError);

      return NextResponse.json({
        totalStores: 0,
        totalReviews: 0,
        averageRating: 0,
        unansweredReviews: 0,
        responseRate: 0,
        totalQRScans: 0,
        totalSurveyResponses: 0,
        todayReviews: 0,
        todayScans: 0,
        hasRealData: false,
        error: "Unable to fetch analytics data",
        period,
        storeId: storeId || null,
      });
    }
  } catch (error) {
    console.error("Analytics GET Error:", error);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 }
    );
  }
}
